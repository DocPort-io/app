name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    env:
      SQLC_VERSION: v1.30.0
      SWAG_VERSION: v1.16.6
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: docport-dev
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Set up pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: 'pnpm'

      - name: Cache Go tools
        uses: actions/cache@v5
        with:
          path: |
            ~/go/bin/sqlc
            ~/go/bin/swag
          key: go-tools-${{ runner.os }}-sqlc-${{ env.SQLC_VERSION }}-swag-${{ env.SWAG_VERSION }}

      - name: Install sqlc (if missing)
        run: |
          if ! command -v sqlc >/dev/null; then
            echo "sqlc not found in PATH, installing ${SQLC_VERSION}..."
            go install github.com/sqlc-dev/sqlc/cmd/sqlc@${SQLC_VERSION}
          fi
          sqlc version

      - name: Install swag (if missing)
        run: |
          if ! command -v swag >/dev/null; then
            echo "swag not found in PATH, installing ${SWAG_VERSION}..."
            go install github.com/swaggo/swag/cmd/swag@${SWAG_VERSION}
          fi
          swag --version

      - name: Install Node.js dependencies
        run: pnpm install

      - name: Run go generate
        run: |
          go version
          go generate ./...

      - name: Setup config file
        run: |
          cp config.test.toml config.toml

      - name: Run tests with coverage
        run: |
          mkdir cover
          pnpm playwright test

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 1

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >-
            -Dsonar.go.coverage.reportPaths=cover
