name: Build

on:
  push:
    branches:
      - main
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    env:
      SQLC_VERSION: v1.30.0
      SWAG_VERSION: v1.16.6
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Cache Go tools
        uses: actions/cache@v5
        with:
          path: |
            ~/go/bin/sqlc
            ~/go/bin/swag
          key: go-tools-${{ runner.os }}-sqlc-${{ env.SQLC_VERSION }}-swag-${{ env.SWAG_VERSION }}

      - name: Install sqlc (if missing)
        run: |
          if ! command -v sqlc >/dev/null; then
            echo "sqlc not found in PATH, installing ${SQLC_VERSION}..."
            go install github.com/sqlc-dev/sqlc/cmd/sqlc@${SQLC_VERSION}
          fi
          sqlc version

      - name: Install swag (if missing)
        run: |
          if ! command -v swag >/dev/null; then
            echo "swag not found in PATH, installing ${SWAG_VERSION}..."
            go install github.com/swaggo/swag/cmd/swag@${SWAG_VERSION}
          fi
          swag --version

      - name: Run go generate
        run: |
          go version
          go generate ./...

      - name: Run tests with coverage
        run: |
          go test ./... -v -coverprofile=coverage.out

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >-
            -Dsonar.go.coverage.reportPaths=coverage.out
